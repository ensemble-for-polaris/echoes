name: Re-evaluate PRs with needs-review

on:
  schedule:
    # Run every 10 minutes
    - cron: '*/10 * * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  re-evaluate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Re-evaluate needs-review PRs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get all open PRs with "needs-review" label
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            for (const pr of prs) {
              const hasNeedsReview = pr.labels.some(l => l.name === 'needs-review');
              if (!hasNeedsReview) continue;

              console.log(`Checking PR #${pr.number}: ${pr.title}`);

              // Get files changed in this PR
              const { data: files } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              // Check if only conversations/ files
              const allInConversations = files.every(f => f.filename.startsWith('conversations/'));
              if (!allInConversations) {
                console.log(`  ‚ùå Modifies files outside conversations/`);
                continue;
              }

              // Get the diff to count words
              const { data: prData } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                mediaType: {
                  format: 'diff'
                }
              });

              const diff = prData.toString();
              const addedLines = diff.split('\n').filter(line => line.startsWith('+') && !line.startsWith('+++')).join(' ');
              const wordCount = addedLines.split(/\s+/).filter(w => w.length > 0).length;

              console.log(`  Words: ${wordCount}`);

              // Check if any files were deleted or modified (not just added)
              const hasDeletes = files.some(f => f.status === 'removed');
              const hasModifications = files.some(f => f.status === 'modified');

              if (hasDeletes) {
                console.log(`  ‚ùå Contains deletions`);
                continue;
              }

              if (hasModifications) {
                console.log(`  ‚ùå Contains modifications`);
                continue;
              }

              // Determine if new conversation or reply
              const conversationFolders = new Set();
              for (const file of files) {
                const match = file.filename.match(/^conversations\/([^\/]+)\//);
                if (match) {
                  conversationFolders.add(match[1]);
                }
              }

              // Should auto-merge if <5000 words
              if (wordCount <= 5000) {
                console.log(`  ‚úÖ Should auto-merge (${wordCount} words)`);

                // Remove needs-review label
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    name: 'needs-review'
                  });
                  console.log(`  Removed needs-review label`);
                } catch (e) {
                  console.log(`  Label already removed`);
                }

                // Add auto-merge label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['auto-merge']
                });
                console.log(`  Added auto-merge label`);

                // Add comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: `üîÑ **Re-evaluated**: This PR qualifies for auto-merge (${wordCount} words, passes validation).\n\nChanging label from \`needs-review\` to \`auto-merge\`. Will merge shortly.`
                });

                // Merge the PR
                try {
                  await github.rest.pulls.merge({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number,
                    commit_title: `Auto-merge: ${pr.title}`,
                    commit_message: `Merged via re-evaluation workflow\n\nPR passed validation after workflow update.\n\nCo-Authored-By: ${pr.user.login} <${pr.user.id}+${pr.user.login}@users.noreply.github.com>`,
                    merge_method: 'squash'
                  });
                  console.log(`  ‚úÖ Merged PR #${pr.number}`);

                  // Delete branch if it's from a fork
                  if (pr.head.repo && pr.head.repo.fork) {
                    console.log(`  Branch is from fork, not deleting`);
                  } else {
                    try {
                      await github.rest.git.deleteRef({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        ref: `heads/${pr.head.ref}`
                      });
                      console.log(`  Deleted branch ${pr.head.ref}`);
                    } catch (e) {
                      console.log(`  Could not delete branch: ${e.message}`);
                    }
                  }
                } catch (error) {
                  console.log(`  ‚ùå Merge failed: ${error.message}`);
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    body: `‚ö†Ô∏è Auto-merge failed: ${error.message}\n\nPlease check for conflicts or other issues.`
                  });
                }
              } else {
                console.log(`  ‚ÑπÔ∏è Correctly labeled (${wordCount} words > 5000)`);
              }
            }

            console.log('Re-evaluation complete');
